export default async function handler(req, res) {
    if (req.method === 'POST') {
        const { country } = req.body;
        
        if (!country) {
            return res.status(400).json({ error: "Cible non identifi√©e." });
        }

        try {
            // 1. COLLECTE DES VECTEURS D'INFLUENCE (RestCountries)
            const countryRes = await fetch(`https://restcountries.com/v3.1/name/${encodeURIComponent(country)}?fullText=true`);
            if (!countryRes.ok) throw new Error("Acc√®s base de donn√©es pays impossible.");
            const countryData = (await countryRes.json())[0];

            // 2. EXTRACTION DES DONN√âES DE PUISSANCE
            const pop = countryData.population;
            const borders = countryData.borders || [];
            const area = countryData.area;
            const region = countryData.region;
            const subregion = countryData.subregion;
            const languages = countryData.languages ? Object.values(countryData.languages) : [];
            const latlng = countryData.latlng || [0, 0];
            
            // 3. ALGORITHME DE SCORING G√âOPOLITIQUE (Puppet Master v4.1 Enhanced)
            
            // A. Classification Rigoureuse des Blocs
            let influenceBloc = "AUTONOME / NON-ALIGN√â";
            let powerColor = "‚ö™";
            
            const westernSubregions = ["Western Europe", "Northern Europe", "Southern Europe", "Northern America"];
            const bricsMembers = ["Russia", "China", "India", "Brazil", "South Africa", "Iran", "Egypt", "Ethiopia", "United Arab Emirates"];
            
            if (westernSubregions.includes(subregion) || ["Australia", "New Zealand", "Japan", "South Korea"].includes(country)) {
                influenceBloc = "BLOC OCCIDENTAL (OTAN/PARTENAIRES)";
                powerColor = "üîµ";
            } else if (bricsMembers.includes(country) || ["Belarus", "Central Asia"].includes(subregion)) {
                influenceBloc = "ALLIANCE EURASIENNE / BRICS+";
                powerColor = "üî¥";
            } else if (["Middle Africa", "Western Africa", "Eastern Africa"].includes(subregion)) {
                influenceBloc = "SUD GLOBAL (INFLUENCE MULTIPOLAIRE)";
                powerColor = "üü°";
            } else if (["South America", "Central America"].includes(subregion)) {
                influenceBloc = "ZONE D'INFLUENCE AM√âRICAINE / SUD GLOBAL";
                powerColor = "üü†";
            }

            // B. Analyse de la Profondeur Strat√©gique
            const density = pop / area;
            // Indice de Puissance (IPP) : Poids relatif territoire/population
            const powerIndex = (Math.log10(pop) * 0.4 + Math.log10(area) * 0.6).toFixed(2);
            
            // C. √âvaluation de la Menace Frontali√®re (Friction Syst√©mique)
            const frictionScore = (borders.length * 1.5).toFixed(1);
            
            // D. D√©termination du Risque G√©opolitique
            let conflictRisk = "STABLE";
            let strategyNote = "Maintien du statu quo.";
            
            if (borders.length >= 7 || (borders.length >= 4 && density > 250)) {
                conflictRisk = "HAUTE FRAGILIT√â (ENCLAVEMENT)";
                strategyNote = "Risque √©lev√© de d√©bordement transfrontalier ou d'instabilit√© interne.";
            } else if (powerIndex > 7.5) {
                conflictRisk = "PUISSANCE R√âGIONALE / H√âG√âMON";
                strategyNote = "Capacit√© de projection et d'influence majeure sur les pays limitrophes.";
            }

            // 4. R√âDACTION DU RAPPORT TECHNIQUE AVANC√â
            const analysis = `
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
  DOSSIER DE RENSEIGNEMENT STRAT√âGIQUE : UNIT√â PUPPET
  SYST√àME DE SURVEILLANCE MONDIAL // ACC√àS NIVEAU 4
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

[IDENTIFICATION DE LA CIBLE]
> NOM : ${country.toUpperCase()}
> COORDONN√âES : ${latlng[0].toFixed(2)}N, ${latlng[1].toFixed(2)}E
> POLARIT√â : ${powerColor} ${influenceBloc}
> RISQUE SYST√âMIQUE : ${conflictRisk}

[1. PARAM√àTRES DE PUISSANCE √âTATIQUE]
> Indice de Profondeur Strat√©gique : ${powerIndex} / 10
> D√©mographie Active : ${(pop / 1000000).toFixed(2)}M d'unit√©s
> Contr√¥le Spatial : ${area.toLocaleString()} km¬≤
> Densit√© de Pression : ${density.toFixed(1)} hab/km¬≤

[2. VECTEURS D'INTERACTION & FRICTION]
> Axes de p√©n√©tration (Fronti√®res) : ${borders.length} points de contact
> Voisinage imm√©diat : ${borders.length > 0 ? borders.join(', ') : 'ISOLEMENT G√âOGRAPHIQUE'}
> Score de Friction Syst√©mique : ${frictionScore} / 15
> Sph√®re d'influence : ${subregion.toUpperCase()}

[3. ANALYSE DE LA DOCTRINE & VULN√âRABILIT√âS]
${strategyNote}
L'analyse structurale indique que ${country} poss√®de une ${area > 1000000 ? 'profondeur strat√©gique majeure permettant d\'absorber des chocs externes' : 'profondeur limit√©e, rendant le territoire vuln√©rable aux man≈ìuvres rapides'}. 
La position g√©ographique ${borders.length > 5 ? 'place le pays au c≈ìur de tensions multilat√©rales complexes' : 'offre une protection relative contre les pressions frontali√®res directes'}.
L'influence linguistique (${languages.slice(0, 2).join(', ')}) constitue un vecteur de soft-power facilitant des ponts diplomatiques vers d'autres zones d'int√©r√™t strat√©gique.

[4. √âTAT DES FLUX]
> Statut Infrastructure : ${pop > 50000000 ? 'R√âSEAU SATUR√â (CRITIQUE)' : 'R√âSEAU FLUIDE'}
> Priorit√© d'Interception : ${powerIndex > 7 ? 'ALPHA (PRIORITAIRE)' : 'GAMMA (OBSERVATION)'}

[STATUS] : ANALYSE VALID√âE PAR L'ALGORITHME V4.1
[SIGNATURE : SECTION_R_STRAT // PUPPET_MASTER]
            `.trim();

            return res.status(200).json({ analysis });

        } catch (error) {
            return res.status(500).json({ 
                error: "D√©faut de liaison", 
                analysis: `[ERREUR CRITIQUE] : Interception impossible. La cible ${country} est prot√©g√©e par un brouillage ou hors r√©seau.` 
            });
        }
    }

    return res.status(405).json({ error: "M√©thode non autoris√©e" });
}
