<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Puppet Strings | Strategic Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=JetBrains+Mono:wght@300;500&display=swap');
        
        :root { 
            --primary: #00f2ff; 
            --bg: #010204; 
            --panel: rgba(2, 6, 12, 0.98); 
        }

        body { 
            background: var(--bg); 
            color: #e2e8f0; 
            margin: 0; 
            overflow: hidden; 
            font-family: 'JetBrains Mono', monospace; 
        }

        .orbitron { font-family: 'Orbitron', sans-serif; }

        .map-container { 
            position: absolute; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            z-index: 1; 
            background: #010204; 
        }

        .country { 
            fill: #080c14; 
            stroke: #1e293b; 
            stroke-width: 0.5; 
            transition: all 0.3s ease; 
            cursor: crosshair; 
            outline: none; 
        }

        .country:hover { 
            fill: #111a2e; 
            stroke: var(--primary); 
            filter: drop-shadow(0 0 5px var(--primary));
        }

        .country.active { 
            fill: rgba(0, 242, 255, 0.15); 
            stroke: var(--primary); 
            stroke-width: 1.5; 
        }

        .panel { 
            pointer-events: auto; 
            background: var(--panel); 
            backdrop-filter: blur(15px); 
            border: 1px solid rgba(0, 242, 255, 0.1); 
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        #overlay { 
            position: fixed; 
            inset: 0; 
            background: #000; 
            z-index: 2000; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: opacity 0.8s ease; 
        }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }
    </style>
</head>
<body>

    <div id="overlay">
        <div class="panel p-16 text-center border-t-2 border-cyan-500 max-w-xl">
            <h2 class="orbitron text-5xl text-white mb-8 font-black italic tracking-tighter">PUPPET_STRINGS</h2>
            <p class="text-[10px] text-cyan-500/60 mb-12 tracking-[0.5em] uppercase font-bold">Terminal de Renseignement Stratégique</p>
            <button onclick="init()" class="group relative border border-cyan-500 px-12 py-5 text-cyan-500 hover:text-black transition-all duration-500 orbitron font-bold overflow-hidden">
                <span class="relative z-10">INITIALISER LA LIAISON</span>
                <div class="absolute inset-0 bg-cyan-500 transform translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
            </button>
        </div>
    </div>

    <div id="map" class="map-container"></div>

    <div class="absolute top-0 left-0 w-full p-10 pointer-events-none z-50 flex justify-between items-start">
        <div class="panel p-6 border-l-4 border-cyan-500">
            <h1 class="text-2xl font-black orbitron text-white tracking-tighter">NETWORK_ACCESS</h1>
            <div class="flex items-center gap-2 mt-1">
                <span class="w-2 h-2 bg-cyan-500 rounded-full animate-pulse"></span>
                <span class="text-[10px] text-cyan-500/80 font-bold uppercase tracking-widest">Proxy: DeepSeek_Secure</span>
            </div>
        </div>
        <div class="panel px-8 py-4 text-right">
            <p id="clock" class="text-xl text-cyan-500 font-mono font-bold leading-none">--:--:-- Z</p>
        </div>
    </div>

    <div id="info" class="absolute right-10 top-32 bottom-20 w-[450px] panel p-10 hidden flex flex-col pointer-events-auto z-50">
        <div class="flex justify-between items-start mb-10">
            <h2 id="c-name" class="orbitron text-4xl text-white font-black uppercase italic leading-none"></h2>
            <button onclick="closeInfo()" class="text-gray-600 hover:text-white transition-colors">✕</button>
        </div>

        <div class="flex-1 overflow-y-auto space-y-8 pr-4">
            <div class="bg-black/40 border border-cyan-500/10 p-8 relative">
                <div id="status-indicator" class="text-[9px] text-cyan-500 font-bold mb-4 uppercase tracking-[0.3em]">En attente de sélection...</div>
                <div id="loader" class="absolute top-0 left-0 h-[1px] bg-cyan-500 w-0 transition-all duration-1000"></div>
                
                <p id="c-intel" class="text-sm leading-relaxed text-slate-300 italic font-light">
                    Sélectionnez une zone géographique sur la carte pour générer un rapport de renseignement via le proxy DeepSeek.
                </p>
            </div>
        </div>
    </div>

    <script>
        let svg, g, projection, path;
        const width = window.innerWidth, height = window.innerHeight;

        function init() {
            document.getElementById('overlay').style.opacity = '0';
            setTimeout(() => document.getElementById('overlay').remove(), 800);
            setupMap();
            setInterval(() => { 
                document.getElementById('clock').innerText = new Date().toLocaleTimeString('fr-FR', { timeZone: 'UTC' }) + " Z"; 
            }, 1000);
        }

        function setupMap() {
            svg = d3.select("#map").append("svg").attr("width", width).attr("height", height);
            g = svg.append("g");
            projection = d3.geoMercator().scale(width / 6.5).translate([width / 2, height / 1.5]);
            path = d3.geoPath().projection(projection);

            d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson").then(data => {
                g.selectAll("path").data(data.features).enter().append("path")
                    .attr("d", path).attr("class", "country")
                    .on("click", (event, d) => selectCountry(event, d));
            });
            svg.call(d3.zoom().scaleExtent([0.8, 12]).on("zoom", (e) => g.attr("transform", e.transform)));
        }

        async function selectCountry(event, d) {
            const name = d.properties.name;
            d3.selectAll(".country").classed("active", false);
            d3.select(event.currentTarget).classed("active", true);
            
            document.getElementById('info').classList.remove('hidden');
            document.getElementById('c-name').innerText = name;
            document.getElementById('c-intel').innerText = "ÉTABLISSEMENT DE LA LIAISON SÉCURISÉE...";
            document.getElementById('status-indicator').innerText = "Décryptage DeepSeek en cours...";
            document.getElementById('loader').style.width = "100%";

            try {
                const response = await fetch("/api/index", {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ country: name })
                });
                const data = await response.json();
                document.getElementById('c-intel').innerText = data.analysis || "Aucune donnée.";
                document.getElementById('status-indicator').innerText = "Rapport complété";
            } catch (error) {
                document.getElementById('c-intel').innerText = "ERREUR : Liaison interrompue.";
            } finally {
                setTimeout(() => { document.getElementById('loader').style.width = "0%"; }, 500);
            }
        }

        function closeInfo() {
            document.getElementById('info').classList.add('hidden');
            d3.selectAll(".country").classed("active", false);
        }
    </script>
</body>
</html>
