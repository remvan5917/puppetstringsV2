<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PUPPET STRINGS SYSTEM | GEOPOLITICAL ORACLE v9.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;500;700&family=Orbitron:wght@400;900&display=swap');
        
        :root { 
            --primary: #00f2ff; 
            --risk: #ff0055;
            --stable: #4ade80;
            --bg: #020408; 
            --panel-bg: rgba(5, 10, 20, 0.98);
            --country-default: #0d1a2d;
        }

        body { 
            background: var(--bg); 
            color: var(--primary); 
            margin: 0; 
            overflow: hidden; 
            font-family: 'Fira Code', monospace;
            text-transform: uppercase;
        }

        .orbitron { font-family: 'Orbitron', sans-serif; }

        .map-container { 
            position: absolute; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            z-index: 1; 
        }

        .country { 
            fill: var(--country-default); 
            stroke: rgba(0, 242, 255, 0.15); 
            stroke-width: 0.5; 
            transition: fill 0.4s ease, stroke 0.3s ease; 
            cursor: crosshair;
        }

        .country:hover { fill: #1a3a5f; stroke: var(--primary); }
        .country.active { fill: rgba(0, 242, 255, 0.4); stroke: var(--primary); stroke-width: 1.5; }

        .terminal-border {
            border: 1px solid rgba(0, 242, 255, 0.2);
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
        }

        #info-panel {
            background: var(--panel-bg);
            transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            transform: translateX(100%);
            border-left: 1px solid rgba(0, 242, 255, 0.2);
            z-index: 100;
        }

        #info-panel.visible { transform: translateX(0); }

        .stat-card {
            background: rgba(255,255,255,0.03);
            padding: 12px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .btn-filter {
            padding: 6px 15px;
            background: black;
            border: 1px solid rgba(0, 242, 255, 0.2);
            font-size: 9px;
            cursor: pointer;
            pointer-events: auto;
        }

        .btn-filter.active { background: var(--primary); color: black; font-weight: bold; }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 1s ease;
        }

        .news-item {
            border-left: 2px solid var(--primary);
            margin-bottom: 8px;
            padding-left: 8px;
            animation: fadeIn 0.5s ease-out;
            font-size: 8px;
            background: rgba(0, 242, 255, 0.03);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .lang-tag {
            font-size: 7px;
            background: rgba(0, 242, 255, 0.2);
            padding: 1px 3px;
            border-radius: 2px;
            margin-right: 5px;
        }

        /* Scanline effect */
        .scanline {
            width: 100%;
            height: 100px;
            z-index: 10;
            background: linear-gradient(0deg, rgba(0, 242, 255, 0) 0%, rgba(0, 242, 255, 0.05) 50%, rgba(0, 242, 255, 0) 100%);
            opacity: 0.1;
            position: absolute;
            bottom: 100%;
            animation: scanline 6s linear infinite;
        }

        @keyframes scanline {
            0% { bottom: 100%; }
            100% { bottom: -100px; }
        }
    </style>
</head>
<body>

    <div id="loader" class="loading-overlay">
        <div class="orbitron text-2xl animate-pulse mb-4 italic tracking-widest">PUPPET_STRINGS_INITIALIZATION...</div>
        <div class="w-64 h-1 bg-gray-900 overflow-hidden relative">
            <div class="h-full bg-cyan-400 w-full animate-pulse"></div>
        </div>
        <p class="text-[8px] mt-4 opacity-50" id="loader-status">PULLING_GLOBAL_STRINGS...</p>
    </div>

    <div class="scanline"></div>
    <div id="map" class="map-container"></div>

    <!-- HUD -->
    <div class="fixed top-0 left-0 w-full h-full pointer-events-none z-50 p-6 flex flex-col justify-between">
        <div class="flex justify-between items-start">
            <div class="terminal-border p-5 pointer-events-auto">
                <div class="flex items-center gap-3">
                    <div class="w-2 h-2 bg-red-600 rounded-full animate-ping"></div>
                    <h1 class="orbitron text-2xl font-black italic tracking-tighter">PUPPET_STRINGS_v9.2</h1>
                </div>
                <div class="flex gap-4 mt-2">
                    <p class="text-[7px] text-cyan-400 font-bold">AUTHORITY: MASTER_ORACLE</p>
                    <p class="text-[7px] opacity-60">STATUS: RECOILING_GLOBAL_SIGNALS</p>
                </div>
            </div>
            
            <div class="text-right pointer-events-auto p-4 terminal-border">
                <div id="clock" class="orbitron text-xl font-bold italic text-white tracking-widest">00:00:00 Z</div>
                <div class="text-[7px] text-red-500 mt-1 font-bold animate-pulse">PUPPET_CONTROL: ACTIVE</div>
            </div>
        </div>

        <div class="flex justify-between items-end">
            <!-- LIVE FEED GDELT -->
            <div class="p-4 terminal-border w-[450px] pointer-events-auto bg-black/90">
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center gap-2">
                        <div class="w-1.5 h-1.5 bg-cyan-500 rounded-full"></div>
                        <span class="text-[8px] font-bold tracking-widest">LIVE_STRING_VIBRATIONS (GDELT)</span>
                    </div>
                    <span class="text-[7px] opacity-40">AUTO-REFRESH: 20s</span>
                </div>
                <div id="log-feed" class="h-40 overflow-hidden flex flex-col gap-1 text-gray-400">
                    <!-- News feed content -->
                </div>
            </div>
            
            <div class="flex flex-col items-end gap-2 pointer-events-auto">
                <div class="flex gap-2" id="filter-group">
                    <button onclick="visualize('neutral', this)" class="btn-filter active">NEUTRE</button>
                    <button onclick="visualize('tone', this)" class="btn-filter border-red-900 text-red-500">TENSION_STRINGS</button>
                    <button onclick="visualize('power', this)" class="btn-filter">PUISSANCE</button>
                </div>
            </div>
        </div>
    </div>

    <!-- INFO PANEL -->
    <div id="info-panel" class="fixed right-0 top-0 h-full w-[480px] flex flex-col p-8 pointer-events-auto shadow-2xl">
        <div class="flex justify-between items-start mb-10">
            <div>
                <h2 id="country-name" class="orbitron text-4xl font-black italic leading-none">--</h2>
                <div id="country-id" class="text-[10px] text-cyan-400 mt-2 font-bold tracking-widest">NODE_ID: --</div>
            </div>
            <button onclick="hidePanel()" class="text-3xl font-light opacity-50 hover:opacity-100 transition-opacity">✕</button>
        </div>

        <div class="flex-1 overflow-y-auto pr-4 space-y-6">
            <div class="grid grid-cols-2 gap-4">
                <div class="stat-card border-red-900/40">
                    <div class="text-[8px] opacity-50 mb-2 uppercase">Vibration des fils (Tone)</div>
                    <div id="stat-tone" class="text-3xl font-bold orbitron">0.0</div>
                </div>
                <div class="stat-card">
                    <div class="text-[8px] opacity-50 mb-2 uppercase">Inertie de Masse</div>
                    <div id="stat-power" class="text-3xl font-bold orbitron">0%</div>
                </div>
            </div>

            <div class="terminal-border p-5 bg-white/5 space-y-3">
                <div class="text-[9px] font-black text-cyan-400 mb-2 border-b border-cyan-900 pb-2 uppercase">Extraction PUPPET_DATA</div>
                <div id="country-news-feed" class="text-[10px] space-y-2 opacity-80 italic">
                    Écoute des fréquences locales...
                </div>
            </div>

            <div class="terminal-border p-5 bg-red-500/5 border-red-900/30">
                <div class="text-[9px] font-black text-red-500 mb-3 tracking-widest uppercase">Directives du Marionnettiste</div>
                <div id="algo-text" class="text-[11px] leading-relaxed text-gray-300 italic uppercase">
                    Veuillez sélectionner une marionnette géographique.
                </div>
            </div>
        </div>
    </div>

    <script>
        let svg, g, projection, path;
        let processedData = new Map();
        let gdeltCache = [];

        // 1. MOTEUR DE DONNÉES GDELT REALTIME
        async function fetchGdeltNews() {
            try {
                const gdeltUrl = `https://api.gdeltproject.org/api/v2/doc/doc?query=(conflict OR crisis OR alert OR diplomatic)&mode=artlist&format=json&maxrecords=15&timespan=1h`;
                const response = await fetch(gdeltUrl);
                const data = await response.json();
                
                if (data && data.articles) {
                    gdeltCache = data.articles;
                    updateLiveFeed(data.articles);
                } else {
                    simulateLiveEvents();
                }
            } catch (e) {
                simulateLiveEvents();
            }
        }

        function updateLiveFeed(articles) {
            const feed = document.getElementById('log-feed');
            if (!feed) return;
            feed.innerHTML = '';
            articles.forEach(art => {
                const item = document.createElement('div');
                item.className = 'news-item p-2';
                item.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="lang-tag">${art.sourcecountry || '??'}</span>
                        <span class="text-cyan-400 font-bold">[STRING_VIBE]</span>
                        <span class="text-white opacity-90">${art.title.substring(0, 75)}...</span>
                    </div>
                `;
                feed.appendChild(item);
            });
        }

        // 2. MOTEUR GÉOGRAPHIQUE
        async function fetchAndProcess() {
            try {
                const response = await fetch('https://restcountries.com/v3.1/all?fields=name,cca3,population,area,borders,region,subregion');
                const data = await response.json();

                data.forEach(c => {
                    const powerScore = Math.min(99, (Math.log10(c.population + 1) * 6 + Math.log10(c.area + 1) * 4));
                    const tone = (Math.random() * 10 - 5).toFixed(1); 

                    processedData.set(c.cca3, {
                        id: c.cca3,
                        name: c.name.common,
                        region: c.region,
                        subregion: c.subregion,
                        population: c.population,
                        area: c.area,
                        scores: { power: powerScore.toFixed(1), tone: tone },
                        borders: c.borders || []
                    });
                });
                
                hideLoader();
                fetchGdeltNews();
            } catch (err) {
                hideLoader();
            }
        }

        function initMap() {
            const width = window.innerWidth, height = window.innerHeight;
            svg = d3.select("#map").append("svg").attr("width", width).attr("height", height);
            g = svg.append("g");
            projection = d3.geoMercator().scale(width / 6.5).translate([width / 2.5, height / 1.5]);
            path = d3.geoPath().projection(projection);

            d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson").then(topo => {
                g.selectAll("path")
                    .data(topo.features)
                    .enter().append("path")
                    .attr("d", path)
                    .attr("class", "country")
                    .on("click", (e, d) => selectCountry(d.id, d.properties.name, e.target));
            });
            svg.call(d3.zoom().scaleExtent([1, 15]).on("zoom", (ev) => g.attr("transform", ev.transform)));
        }

        function selectCountry(id, rawName, element) {
            d3.selectAll(".country").classed("active", false);
            if(element) d3.select(element).classed("active", true);

            const data = processedData.get(id);
            const panel = document.getElementById('info-panel');
            panel.classList.add('visible');

            if (data) {
                document.getElementById('country-name').innerText = data.name;
                document.getElementById('country-id').innerText = `NODE_ID: ${data.id} // STRINGS_SYNC: ACTIVE`;
                document.getElementById('stat-tone').innerText = data.scores.tone;
                document.getElementById('stat-tone').style.color = data.scores.tone < 0 ? 'var(--risk)' : 'var(--stable)';
                document.getElementById('stat-power').innerText = data.scores.power + '%';
                
                const relevantNews = gdeltCache.filter(a => 
                    a.title.toLowerCase().includes(data.name.toLowerCase()) || 
                    (a.sourcecountry && a.sourcecountry.toLowerCase() === data.id.toLowerCase())
                );
                
                const newsFeed = document.getElementById('country-news-feed');
                if(relevantNews.length > 0) {
                    newsFeed.innerHTML = relevantNews.map(n => `
                        <div class="mb-2 border-b border-white/5 pb-1 text-gray-400">
                            <span class="text-cyan-400 font-bold">[PUPPET_LOG]</span> ${n.title}
                        </div>
                    `).join('');
                } else {
                    newsFeed.innerHTML = "Pas de signal de vibration local capté par les fils du système.";
                }

                document.getElementById('algo-text').innerText = `DIRECTIVE: Node ${data.name} présente un coefficient d'agitation de ${Math.abs(data.scores.tone)}. Statut Puppet: ${data.scores.tone < 0 ? 'RECALIBRATION_RECOMMANDÉE' : 'MAINTENIR_TENSION'}.`;
            } else {
                document.getElementById('country-name').innerText = rawName;
                document.getElementById('algo-text').innerText = "NODE_SYNC_FAILED: La marionnette est hors de portée.";
            }
        }

        function hidePanel() {
            document.getElementById('info-panel').classList.remove('visible');
        }

        function visualize(type, btn) {
            document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            g.selectAll("path").transition().duration(600).style("fill", d => {
                const data = processedData.get(d.id);
                if (!data) return "var(--country-default)";
                if (type === 'tone') {
                    return data.scores.tone < 0 ? d3.interpolateReds(Math.abs(data.scores.tone)/10) : d3.interpolateGreens(data.scores.tone/10);
                }
                if (type === 'power') return d3.interpolateBlues(data.scores.power / 100);
                return "var(--country-default)";
            });
        }

        function hideLoader() { 
            const loader = document.getElementById('loader');
            if (loader) {
                loader.style.opacity = '0'; 
                setTimeout(()=>loader.remove(), 1000); 
            }
        }

        function simulateLiveEvents() {
            const mockNews = [
                { sourcecountry: "GLO", title: "PUPPET_STRINGS: Global synchronization in progress" },
                { sourcecountry: "SYS", title: "SYSTEM_STATUS: All global nodes responding to tension" },
                { sourcecountry: "LOG", title: "NEWS_STREAM: Aggregating multilingual vibrations" }
            ];
            updateLiveFeed(mockNews);
        }

        window.onload = () => {
            initMap();
            fetchAndProcess();
            setInterval(fetchGdeltNews, 20000);
            setInterval(() => { 
                const clock = document.getElementById('clock');
                if (clock) clock.innerText = new Date().toISOString().split('T')[1].split('.')[0] + " Z"; 
            }, 1000);
        };
    </script>
</body>
</html>
