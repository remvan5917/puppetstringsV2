<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORACLE SYSTEMIC v7.1 | DEEP DATA FUSION</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;500;700&family=Orbitron:wght@400;900&display=swap');
        
        :root { 
            --primary: #00f2ff; 
            --accent: #ff0055;
            --warning: #ffcc00;
            --bg: #020408; 
            --panel-bg: rgba(5, 10, 20, 0.95);
            --country-default: #0d1a2d;
        }

        body { 
            background: var(--bg); 
            color: var(--primary); 
            margin: 0; 
            overflow: hidden; 
            font-family: 'Fira Code', monospace;
            text-transform: uppercase;
        }

        .orbitron { font-family: 'Orbitron', sans-serif; }

        /* Effet CRT/Glitch */
        body::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.02), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.02));
            z-index: 1000;
            background-size: 100% 3px, 3px 100%;
            pointer-events: none;
        }

        .map-container { 
            position: absolute; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            z-index: 1; 
        }

        .country { 
            fill: var(--country-default); 
            stroke: rgba(0, 242, 255, 0.15); 
            stroke-width: 0.5; 
            transition: fill 0.8s cubic-bezier(0.4, 0, 0.2, 1), stroke 0.3s ease; 
            cursor: crosshair;
        }

        .country:hover { 
            fill: #1a3a5f; 
            stroke: var(--primary);
            filter: drop-shadow(0 0 8px var(--primary));
        }

        .country.active { 
            fill: rgba(0, 242, 255, 0.3); 
            stroke: var(--primary); 
            stroke-width: 2; 
        }

        .terminal-border {
            border: 1px solid rgba(0, 242, 255, 0.2);
            position: relative;
            background: rgba(0,0,0,0.8);
        }

        .terminal-border::before {
            content: '';
            position: absolute;
            top: -2px; left: -2px; width: 10px; height: 10px;
            border-top: 2px solid var(--primary); border-left: 2px solid var(--primary);
        }

        #info-panel {
            background: var(--panel-bg);
            backdrop-filter: blur(10px);
            transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            transform: translateX(100%);
            border-left: 1px solid rgba(0, 242, 255, 0.2);
            box-shadow: -10px 0 30px rgba(0,0,0,0.5);
        }

        #info-panel.visible { transform: translateX(0); }

        .gauge-container {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.05);
            margin-top: 6px;
            position: relative;
            overflow: hidden;
            border-radius: 3px;
        }

        .gauge-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 1.2s ease-out;
            box-shadow: 0 0 10px var(--primary);
        }

        .stat-card {
            background: rgba(255,255,255,0.03);
            padding: 10px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px;}
        
        .btn-filter {
            padding: 4px 12px;
            background: black;
            border: 1px solid rgba(0, 242, 255, 0.2);
            font-size: 8px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .btn-filter:hover {
            background: rgba(0, 242, 255, 0.1);
            border-color: var(--primary);
        }
        
        .btn-filter.active {
            background: var(--primary);
            color: black;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="map" class="map-container"></div>

    <!-- Interface HUD -->
    <div class="fixed top-0 left-0 w-full h-full pointer-events-none z-50 p-6 flex flex-col justify-between">
        <div class="flex justify-between items-start">
            <div class="terminal-border p-4 pointer-events-auto">
                <h1 class="orbitron text-2xl font-black italic tracking-tighter flex items-center gap-3">
                    <span class="w-3 h-3 bg-cyan-400 animate-pulse rounded-full"></span>
                    STRAT_ORACLE_v7.1
                </h1>
                <div class="flex gap-4 mt-2">
                    <p class="text-[7px] opacity-60">SOURCE: WB_API + REST_C</p>
                    <p class="text-[7px] text-green-400 font-bold">MODE: DEEP_FUSION_ACTIVE</p>
                </div>
            </div>
            
            <div class="text-right pointer-events-auto p-3 terminal-border">
                <div id="clock" class="orbitron text-xl font-bold italic tracking-widest text-white">00:00:00 Z</div>
                <div class="flex justify-end gap-2 mt-1">
                    <span class="text-[6px] px-1 bg-cyan-900 text-cyan-200">CORE_TEMP: 34°C</span>
                    <span class="text-[6px] px-1 bg-red-900 text-red-200">THREAT_LVL: MODERATE</span>
                </div>
            </div>
        </div>

        <div class="flex justify-between items-end">
            <div class="p-3 terminal-border max-w-sm pointer-events-auto">
                <div class="flex items-center gap-2 mb-2">
                    <div class="w-2 h-2 bg-yellow-500 rounded-full animate-ping"></div>
                    <span class="text-[9px] font-bold text-yellow-500 italic">LOG_ACTIVITÉ_SÉCURITÉ</span>
                </div>
                <p class="text-[8px] leading-tight opacity-70 mb-1" id="log-feed">
                    > ANALYSEUR SYSTÉMIQUE INITIALISÉ...<br>
                    > CHARGEMENT DES COORDONNÉES GÉO-POLITIQUES...
                </p>
            </div>
            <div class="flex flex-col items-end gap-2 pointer-events-auto">
                <div class="text-[8px] opacity-50 mb-1">UNITÉ DE VISION TACTIQUE</div>
                <div class="flex gap-2" id="filter-group">
                    <button onclick="resetMap(this)" class="btn-filter active">VISION NEUTRE</button>
                    <button onclick="colorMap('power', this)" class="btn-filter border-cyan-900 text-cyan-400">PUISSANCE</button>
                    <button onclick="colorMap('vulnerability', this)" class="btn-filter border-red-900 text-red-400">VULNÉRABILITÉ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Panneau d'Information Stratégique -->
    <div id="info-panel" class="fixed right-0 top-0 h-full w-[480px] z-[100] flex flex-col p-8 pointer-events-auto">
        <div class="flex justify-between items-start mb-6">
            <div>
                <h2 id="country-name" class="orbitron text-3xl font-black italic tracking-tighter leading-none">--</h2>
                <div id="country-region" class="text-[9px] text-cyan-400 mt-2 font-bold opacity-70 tracking-widest">--</div>
            </div>
            <button onclick="hidePanel()" class="hover:text-red-500 transition-colors text-2xl font-light">✕</button>
        </div>

        <div class="flex-1 overflow-y-auto custom-scroll pr-2">
            <!-- MATRICE DES SCORES -->
            <div class="grid grid-cols-2 gap-3 mb-6">
                <div class="stat-card">
                    <div class="text-[7px] opacity-60 mb-1 tracking-widest">PUISSANCE GLOBALE</div>
                    <div class="text-xl font-bold orbitron" id="stat-power">--</div>
                    <div class="gauge-container"><div id="bar-power" class="gauge-fill"></div></div>
                </div>
                <div class="stat-card">
                    <div class="text-[7px] opacity-60 mb-1 tracking-widest">INDICE DOMINO</div>
                    <div class="text-xl font-bold orbitron" id="stat-domino">--</div>
                    <div class="gauge-container"><div id="bar-domino" class="gauge-fill"></div></div>
                </div>
                <div class="stat-card">
                    <div class="text-[7px] opacity-60 mb-1 tracking-widest">AGILITÉ PIVOT</div>
                    <div class="text-xl font-bold orbitron" id="stat-agility">--</div>
                    <div class="gauge-container"><div id="bar-agility" class="gauge-fill"></div></div>
                </div>
                <div class="stat-card">
                    <div class="text-[7px] opacity-60 mb-1 tracking-widest">VULNÉRABILITÉ</div>
                    <div class="text-xl font-bold orbitron text-red-500" id="stat-vulnerability">--</div>
                    <div class="gauge-container"><div id="bar-vulnerability" class="gauge-fill" style="background: var(--accent)"></div></div>
                </div>
            </div>

            <!-- NOUVELLES DONNÉES ÉCONOMIQUES & RISQUES -->
            <div class="space-y-4 mb-8">
                <div class="terminal-border p-4 bg-white/5">
                    <div class="text-[8px] font-bold text-cyan-400 mb-3 border-b border-cyan-900 pb-1">INDICATEURS ÉCONOMIQUES (EST.)</div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[9px]">PIB (PARITÉ POUVOIR ACHAT)</span>
                        <span id="eco-gdp" class="text-[10px] font-bold text-white">CALCUL...</span>
                    </div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[9px]">EXPOSITION MARCHÉS</span>
                        <span id="eco-market" class="text-[10px] font-bold text-white">--</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-[9px]">STABILITÉ DEVISE</span>
                        <span id="eco-currency" class="text-[10px] font-bold text-green-400">STABLE</span>
                    </div>
                </div>

                <div class="terminal-border p-4 bg-white/5">
                    <div class="text-[8px] font-bold text-red-400 mb-3 border-b border-red-900 pb-1">MATRICE DE RISQUE SYSTÉMIQUE</div>
                    <div id="risk-analysis" class="text-[10px] leading-relaxed opacity-80">
                        ANALYSE DES FLUX EN COURS...
                    </div>
                </div>
            </div>

            <!-- RAPPORT DÉTAILLÉ -->
            <div id="report-text" class="text-[9px] leading-relaxed whitespace-pre-wrap opacity-70 bg-black/40 p-4 border border-white/5 rounded italic">
                SÉLECTIONNEZ UNE ZONE D'INTÉRÊT SUR LA CARTE...
            </div>
        </div>

        <div class="mt-6 pt-4 border-t border-white/10 flex justify-between items-center">
            <div class="text-[7px] opacity-40">ORACLE_SYSTEM_CORE_V7.1.0</div>
            <div class="flex items-center gap-2">
                <span class="text-[7px] text-cyan-500 font-bold">LIAISON_ACTIVE</span>
                <div class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div>
            </div>
        </div>
    </div>

    <script>
        let svg, g, projection, path, worldData;
        const countryNameMap = { "USA": "United States", "UK": "United Kingdom", "Russia": "Russian Federation" };

        // 1. MOTEUR DE CALCUL STRATÉGIQUE AMÉLIORÉ
        function processDeepData(c) {
            const pop = c.population || 0;
            const area = c.area || 1;
            const neighbors = c.borders || [];
            const isLandlocked = c.landlocked || false;
            const subregion = c.subregion || "";
            const region = c.region || "";

            const powerRaw = (Math.log10(pop + 1) * 7.5 + Math.log10(area + 1) * 2.5);
            const powerScore = Math.min(100, powerRaw).toFixed(1);
            
            const dominoImpact = (neighbors.length > 0 ? (Math.log10(pop + 1) * neighbors.length / 2.2) : 0);
            const dominoScore = Math.min(100, dominoImpact * 10).toFixed(1);

            const agilityScore = (!isLandlocked && area < 400000 && neighbors.length >= 2) ? 88 : 38;

            const density = pop / area;
            let vulnerability = (isLandlocked ? 40 : 10) + (neighbors.length > 5 ? 20 : 0) + (density > 500 ? 25 : 0);
            if (region === 'Africa' || subregion === 'Western Asia') vulnerability += 15;
            const vulnerabilityScore = Math.min(100, vulnerability).toFixed(1);

            const gdpFactor = region === 'Europe' ? 45000 : (region === 'Americas' ? 30000 : 8000);
            const estimatedGDP = (pop * gdpFactor / 1e9).toFixed(1);

            let market = "DIVERSIFIÉ / GLOBAL";
            if (subregion.includes("Middle East") || region === "Africa") market = "ENERGY / COMMODITIES";
            else if (pop > 1e8) market = "DOMESTIC CONSUMPTION / TECH";
            else if (isLandlocked) market = "REGIONAL LOGISTICS";

            return {
                analysis: `[SÉCURITÉ] : ${vulnerabilityScore > 60 ? 'ALERTE : VULNÉRABILITÉ STRUCTURELLE ÉLEVÉE.' : 'STABILITÉ : ARCHITECTURE RÉSILIENTE.'}\n[ZONE] : Sub-region ${subregion} présente un coefficient de friction de ${(neighbors.length * 1.2).toFixed(1)}.\n[PIVOT] : ${agilityScore > 70 ? 'Capacité d\'arbitrage flux-marché détectée.' : 'Position d\'inertie stabilisatrice.'}`,
                scores: { power: powerScore, domino: dominoScore, agility: agilityScore, vulnerability: vulnerabilityScore },
                economics: { gdp: estimatedGDP, market: market, currency: vulnerabilityScore > 55 ? "VOLATILE" : "STABLE" }
            };
        }

        // 2. INITIALISATION CARTE D3
        function init() {
            const width = window.innerWidth, height = window.innerHeight;
            svg = d3.select("#map").append("svg").attr("width", width).attr("height", height);
            g = svg.append("g");
            projection = d3.geoMercator().scale(width / 6.2).translate([width / 2.4, height / 1.5]);
            path = d3.geoPath().projection(projection);

            d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson").then(data => {
                worldData = data;
                g.selectAll("path")
                    .data(data.features)
                    .enter().append("path")
                    .attr("d", path)
                    .attr("class", "country")
                    .attr("id", d => `c-${d.id}`)
                    .on("click", (e, d) => analyzeCountry(d.properties.name, e.target));
                
                logMessage("CARTE GÉO-POLITIQUE CHARGÉE. PRÊT.");
            });

            svg.call(d3.zoom().scaleExtent([1, 15]).on("zoom", (event) => g.attr("transform", event.transform)));
            setInterval(() => { document.getElementById('clock').innerText = new Date().toISOString().split('T')[1].split('.')[0] + " Z"; }, 1000);
        }

        // 3. ANALYSE PROFONDE (API + CALCULS)
        async function analyzeCountry(rawName, element) {
            d3.selectAll(".country").classed("active", false);
            d3.select(element).classed("active", true);

            document.getElementById('info-panel').classList.add('visible');
            document.getElementById('country-name').innerText = "CALCULS...";
            logMessage(`ACQUISITION CIBLE: ${rawName}...`);

            const searchName = countryNameMap[rawName] || rawName;

            try {
                const response = await fetch(`https://restcountries.com/v3.1/name/${encodeURIComponent(searchName)}?fullText=true`);
                const data = await response.json();
                
                if (!data || data.status === 404 || !data[0]) throw new Error("Cible Hors Radar");
                
                const c = data[0];
                const res = processDeepData(c);

                setTimeout(() => {
                    document.getElementById('country-name').innerText = c.name.common;
                    document.getElementById('country-region').innerText = `${c.region} // ${c.subregion}`;
                    document.getElementById('report-text').innerText = res.analysis;
                    
                    document.getElementById('eco-gdp').innerText = `$${res.economics.gdp} BN (EST.)`;
                    document.getElementById('eco-market').innerText = res.economics.market;
                    document.getElementById('eco-currency').innerText = res.economics.currency;
                    document.getElementById('eco-currency').style.color = res.economics.currency === "STABLE" ? "#4ade80" : "#ff0055";

                    updateGauge('power', res.scores.power);
                    updateGauge('domino', res.scores.domino);
                    updateGauge('agility', res.scores.agility);
                    updateGauge('vulnerability', res.scores.vulnerability);

                    document.getElementById('risk-analysis').innerHTML = generateRiskMatrix(res.scores, c);
                    logMessage(`ANALYSE COMPLÈTE: ${c.cca3} SYNC.`);
                }, 300);

            } catch (err) {
                document.getElementById('country-name').innerText = "ERROR";
                document.getElementById('report-text').innerText = `!!! ÉCHEC DE LIAISON !!!\nCible: ${rawName}\nCause: ${err.message}`;
                logMessage(`ERREUR_SATELLITE: ${rawName} NON IDENTIFIÉ.`);
            }
        }

        function generateRiskMatrix(scores, c) {
            const v = scores.vulnerability;
            let msg = v > 70 ? "CRITIQUE : Haut risque d'effondrement des flux en cas de tension régionale." : 
                      (v > 40 ? "MODÉRÉ : Sensibilité aux chocs logistiques externes." : "FAIBLE : Structure solide face aux pressions systémiques.");
            
            return `<div class="mb-2">${msg}</div>
                    <div class="flex gap-2 flex-wrap mt-3">
                        <span class="text-[7px] px-2 py-0.5 bg-red-900/40 border border-red-500 text-red-200">RISQUE_DOMINO: ${scores.domino}%</span>
                        <span class="text-[7px] px-2 py-0.5 bg-cyan-900/40 border border-cyan-500 text-cyan-200">CONNECTIVITÉ: ${c.borders?.length || 0} VOISINS</span>
                    </div>`;
        }

        // 4. FONCTIONS DE VISUALISATION (CHOROPLÈTHE ET RESET)
        async function colorMap(type, btn) {
            setActiveButton(btn);
            logMessage(`RECOLORATION CARTE: MODE ${type.toUpperCase()}...`);
            
            g.selectAll("path").transition().duration(800).style("fill", d => {
                const dummyVal = Math.random(); 
                if (type === 'power') return d3.interpolateBlues(dummyVal * 0.7 + 0.3);
                return d3.interpolateReds(dummyVal * 0.7 + 0.3);
            });
        }

        function resetMap(btn) {
            setActiveButton(btn);
            logMessage("RÉINITIALISATION VISION NEUTRE...");
            g.selectAll("path")
                .transition()
                .duration(800)
                .style("fill", "var(--country-default)");
        }

        function setActiveButton(btn) {
            const buttons = document.querySelectorAll('#filter-group .btn-filter');
            buttons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function updateGauge(id, val) {
            document.getElementById(`stat-${id}`).innerText = val + '%';
            document.getElementById(`bar-${id}`).style.width = val + '%';
        }

        function hidePanel() { document.getElementById('info-panel').classList.remove('visible'); d3.selectAll(".country").classed("active", false); }

        function logMessage(msg) {
            const feed = document.getElementById('log-feed');
            feed.innerHTML = `> ${msg}<br>` + feed.innerHTML.split('<br>').slice(0, 2).join('<br>');
        }

        window.onload = init;
        window.onresize = () => location.reload();
    </script>
</body>
</html>
