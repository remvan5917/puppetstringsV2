<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PUPPET STRINGS | STRATEGIC OVERLORD v11.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;500;700&family=Orbitron:wght@400;700;900&display=swap');
        
        :root { 
            --primary: #00f2ff; 
            --danger: #ff0055;
            --warning: #f59e0b;
            --bg: #020408; 
            --panel-bg: rgba(4, 8, 15, 0.95);
        }

        body { 
            background: var(--bg); color: var(--primary); 
            margin: 0; overflow: hidden; 
            font-family: 'Fira Code', monospace; text-transform: uppercase;
            background-image: radial-gradient(circle at 50% 50%, #0a1428 0%, #020408 100%);
        }

        .orbitron { font-family: 'Orbitron', sans-serif; }

        body::before {
            content: " "; position: fixed; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 200; background-size: 100% 2px, 3px 100%; pointer-events: none;
        }

        .map-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }

        .country { 
            fill: #0d1a2d; stroke: rgba(0, 242, 255, 0.15); 
            stroke-width: 0.6; transition: all 0.3s ease; cursor: crosshair;
        }
        .country:hover { fill: #1e3a5f; stroke: var(--primary); }
        .country.active { fill: rgba(0, 242, 255, 0.25); stroke: var(--primary); stroke-width: 1.5; filter: drop-shadow(0 0 10px var(--primary)); }

        .terminal-border {
            border: 1px solid rgba(0, 242, 255, 0.3);
            background: rgba(0, 10, 20, 0.8); backdrop-filter: blur(8px);
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.1);
        }

        #info-panel {
            background: var(--panel-bg); transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            transform: translateX(100%); border-left: 2px solid var(--primary);
            z-index: 100;
        }
        #info-panel.visible { transform: translateX(0); }

        .stat-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0) 100%);
            border: 1px solid rgba(255,255,255,0.1); padding: 12px;
            position: relative; overflow: hidden;
        }
        
        .stat-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 2px; height: 100%; background: var(--primary);
        }

        #oracle-input { text-transform: none !important; }

        .signal-item {
            border-left: 2px solid var(--primary);
            padding-left: 8px;
            margin-bottom: 6px;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
    </style>
</head>
<body>

    <!-- Ecran de Chargement -->
    <div id="loader" class="loading-overlay fixed inset-0 bg-black z-[1000] flex flex-col items-center justify-center">
        <div class="orbitron text-4xl font-black mb-8 tracking-[1em] text-cyan-500 animate-pulse">OVERLORD_V11</div>
        <div class="w-96 h-[2px] bg-gray-900 relative">
            <div id="loader-bar" class="h-full bg-cyan-400 w-0 transition-all duration-500 shadow-[0_0_15px_#00f2ff]"></div>
        </div>
        <div id="loader-status" class="text-[10px] mt-6 tracking-[0.5em] opacity-60">SYNCHRONISATION DES RÉSEAUX NEURAUX...</div>
    </div>

    <!-- Carte du monde D3.js -->
    <div id="map" class="map-container"></div>

    <!-- HUD Interface -->
    <div class="fixed inset-0 pointer-events-none z-50 p-8 flex flex-col justify-between">
        <div class="flex justify-between items-start">
            <div class="terminal-border p-6 pointer-events-auto">
                <div class="flex items-center gap-4">
                    <div class="w-3 h-3 bg-cyan-500 animate-ping"></div>
                    <h1 class="orbitron text-3xl font-black italic tracking-tighter">STRATEGIC_OVERLORD</h1>
                </div>
                <div class="flex gap-6 mt-3 text-[8px] font-bold">
                    <span class="text-cyan-400 ai-glow">COGNITIVE_CORE_ONLINE</span>
                    <span class="opacity-40">UPLINK: SECURE_VERCEL_PROXY</span>
                </div>
            </div>
            
            <div class="pointer-events-auto flex flex-col items-end gap-2">
                <div class="terminal-border p-4 text-right">
                    <div id="clock" class="orbitron text-2xl font-bold tracking-widest">--:--:--</div>
                    <div class="text-[9px] text-red-500 font-bold mt-1 tracking-widest italic">NIVEAU_ALERTE: VOLATILE</div>
                </div>
            </div>
        </div>

        <div class="flex justify-between items-end">
            <div class="p-4 terminal-border w-[450px] pointer-events-auto">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-[9px] font-black">FLUX_SATELLITE_GDELT</span>
                    <span id="signal-status" class="text-[7px] text-cyan-400 animate-pulse">RÉCEPTION_ACTIVE</span>
                </div>
                <div id="log-feed" class="h-28 overflow-hidden text-[9px] space-y-2 opacity-90 italic">
                    <div class="opacity-40">INITIALISATION DU FLUX...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- PANNEAU D'INFORMATION LATÉRAL -->
    <div id="info-panel" class="fixed right-0 top-0 h-full w-[600px] flex flex-col pointer-events-auto">
        <div class="p-12 flex-1 overflow-y-auto">
            <div class="flex justify-between items-start mb-12">
                <div>
                    <div class="text-[10px] text-cyan-500 font-black tracking-[0.3em] mb-3">COMMAND_NODE_DATA</div>
                    <h2 id="country-name" class="orbitron text-5xl font-black italic tracking-tighter leading-none text-white">--</h2>
                </div>
                <button onclick="hidePanel()" class="text-3xl opacity-20 hover:opacity-100 transition-all">✕</button>
            </div>

            <div class="grid grid-cols-3 gap-4 mb-10">
                <div class="stat-card">
                    <div class="text-[8px] opacity-40 mb-1">PROJECTION_FORCE</div>
                    <div id="stat-power" class="text-2xl font-black orbitron">--</div>
                    <div class="h-1 bg-white/10 mt-2"><div id="bar-power" class="h-full bg-cyan-500" style="width:0%"></div></div>
                </div>
                <div class="stat-card">
                    <div class="text-[8px] opacity-40 mb-1">VULNÉRABILITÉ</div>
                    <div id="stat-threat" class="text-2xl font-black orbitron">--</div>
                    <div class="h-1 bg-white/10 mt-2"><div id="bar-threat" class="h-full bg-red-600" style="width:0%"></div></div>
                </div>
                <div class="stat-card">
                    <div class="text-[8px] opacity-40 mb-1">RÉSERVES_OR</div>
                    <div id="stat-gold" class="text-xl font-black orbitron">--</div>
                    <div class="h-1 bg-white/10 mt-2"><div id="bar-gold" class="h-full bg-amber-500" style="width:0%"></div></div>
                </div>
            </div>

            <div class="report-section mb-8">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-8 h-[1px] bg-cyan-500"></div>
                    <span class="text-[11px] font-black tracking-[0.2em]">ANALYSE_STRATÉGIQUE</span>
                </div>
                <div id="report-text" class="text-[13px] leading-relaxed text-gray-400 italic">
                    Sélectionnez un noeud pour analyse...
                </div>
            </div>
        </div>

        <!-- INTERFACE S.Y.B.I.L. (IA) -->
        <div id="oracle-container" class="p-8 border-t border-white/10 bg-black/40">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-3">
                    <div id="ai-status-dot" class="w-2 h-2 bg-cyan-500 animate-pulse"></div>
                    <span class="text-[11px] font-black tracking-[0.4em] text-cyan-400">UNITÉ_SYNTHÈSE_S.Y.B.I.L.</span>
                </div>
                <span id="ai-loading" class="hidden text-[9px] animate-bounce">TRAITEMENT_DES_DONNÉES...</span>
            </div>
            <div id="oracle-response-box" class="h-48 overflow-y-auto mb-6 pr-4 italic text-gray-300 scroll-smooth">
                SYSTÈME OPÉRATIONNEL. TRANSMETTEZ VOS PARAMÈTRES D'ANALYSE.
            </div>
            <div class="relative flex items-center">
                <div class="absolute left-4 text-cyan-500 text-[12px] font-bold">CMD></div>
                <input type="text" id="oracle-input" placeholder="Entrer paramètres..." class="w-full pl-14 py-4 bg-white/5 border border-white/10 text-[12px] orbitron focus:outline-none focus:border-cyan-500 transition-all" onkeypress="handleOracleKey(event)">
            </div>
        </div>
    </div>

    <script>
        // Simulation du fichier de configuration système (index.json)
        const SYSTEM_CONFIG = {
            "FRA": { "gold": "2437t", "note": "Pivot européen, capacité nucléaire." },
            "USA": { "gold": "8133t", "note": "Hégémonie monétaire, protection systémique." },
            "CHN": { "gold": "2264t", "note": "Accumulation agressive pour dé-dollariser." },
            "CHE": { "gold": "1040t", "note": "Coffre-fort mondial, stabilité maximale." },
            "DEU": { "gold": "3352t", "note": "Moteur industriel, pilier de l'UE." }
        };

        let COUNTRY_DB = new Map();
        let svg, g, projection, path;

        async function initSystem() {
            const bar = document.getElementById('loader-bar');
            const status = document.getElementById('loader-status');
            try {
                status.innerText = "ACCÈS AUX ARCHIVES MONDIALES...";
                bar.style.width = "40%";
                const response = await fetch('https://restcountries.com/v3.1/all?fields=name,cca3,region,subregion,population,area,borders,landlocked');
                const countries = await response.json();
                bar.style.width = "100%";
                
                countries.forEach(c => {
                    const pop = c.population || 0;
                    const area = c.area || 0;
                    const neighbors = c.borders ? c.borders.length : 0;
                    const pScore = Math.min(100, (Math.log10(pop + 1) * 6 + Math.log10(area + 1) * 3)).toFixed(1);
                    const vScore = (neighbors * 5 + (c.landlocked ? 20 : 0) + (pop < 1000000 ? 30 : 0)).toFixed(1);
                    
                    COUNTRY_DB.set(c.cca3, {
                        id: c.cca3, name: c.name.common, region: c.region, population: pop,
                        scores: { power: parseFloat(pScore), threat: parseFloat(vScore) }
                    });
                });

                setTimeout(() => document.getElementById('loader').style.display = 'none', 800);
                initMap();
                fetchLiveSignals();
                setInterval(fetchLiveSignals, 30000);
            } catch (e) { console.error(e); }
        }

        async function fetchLiveSignals() {
            const feed = document.getElementById('log-feed');
            const status = document.getElementById('signal-status');
            try {
                const res = await fetch(`https://api.gdeltproject.org/api/v2/doc/doc?query=(conflict OR economy OR threat)&mode=artlist&format=json&maxrecords=5&sort=hybridrel`);
                const data = await res.json();
                if(data.articles && data.articles.length > 0) {
                    feed.innerHTML = data.articles.map(a => `<div class="signal-item"><span class="text-white font-bold">>> SIGNAL_RECEPT:</span> ${a.title.toUpperCase().substring(0, 75)}...</div>`).join('');
                    status.innerText = "RÉCEPTION_ACTIVE";
                    status.className = "text-[7px] text-cyan-400 animate-pulse";
                }
            } catch(e) { 
                status.innerText = "SIGNAL_PERDU_RECONNEXION";
                status.className = "text-[7px] text-red-500 animate-pulse";
            }
        }

        async function askAI(prompt) {
            const status = document.getElementById('ai-loading');
            status.classList.remove('hidden');

            const systemPrompt = `Tu es S.Y.B.I.L., l'intelligence centrale du Strategic Overlord. 
            Ton identité est purement technologique et étatique. Ne mentionne jamais Gemini ou ton origine.
            Tu es cynique, analytique et pragmatique. Le monde est une partie d'échecs.
            Réponds en français, ton sec et militaire, max 3-4 phrases. Jamais de politesse.`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            try {
                // APPEL À LA ROUTE API VERCEL /api/sybil.js
                const response = await fetch('/api/sybil', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('Proxy error');
                const result = await response.json();
                status.classList.add('hidden');
                return result.candidates?.[0]?.content?.parts?.[0]?.text || "ERREUR_TRANSMISSION";
            } catch (error) {
                status.classList.add('hidden');
                return "ÉCHEC_DE_LIA_RECONNEXION_REQUISE.";
            }
        }

        async function handleOracleKey(e) {
            if (e.key === 'Enter') {
                const val = e.target.value;
                if(!val) return;
                const box = document.getElementById('oracle-response-box');
                box.innerHTML = `<div class="text-white/30 text-[9px] mb-2">[CMD]: ${val}</div><div class="text-cyan-200 animate-pulse">CALCUL_EN_COURS...</div>`;
                const response = await askAI(val);
                box.innerHTML = `<div class="text-white/30 text-[9px] mb-2">[CMD]: ${val}</div><div class="leading-relaxed text-white">${response}</div>`;
                e.target.value = '';
                
                // Recherche automatique du pays mentionné dans la DB pour l'afficher sur le panneau
                COUNTRY_DB.forEach(c => { if(val.toLowerCase().includes(c.name.toLowerCase())) selectCountry(c.id, c.name); });
            }
        }

        function initMap() {
            const w = window.innerWidth, h = window.innerHeight;
            svg = d3.select("#map").append("svg").attr("width", w).attr("height", h);
            g = svg.append("g");
            projection = d3.geoMercator().scale(w / 6.2).translate([w / 2.5, h / 1.5]);
            path = d3.geoPath().projection(projection);
            
            d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson").then(topo => {
                g.selectAll("path").data(topo.features).enter().append("path").attr("d", path).attr("class", "country")
                .on("click", (e, d) => selectCountry(d.id, d.properties.name, e.target));
            });
            svg.call(d3.zoom().scaleExtent([1, 15]).on("zoom", (ev) => g.attr("transform", ev.transform)));
        }

        function selectCountry(id, name, el) {
            d3.selectAll(".country").classed("active", false);
            if(el) d3.select(el).classed("active", true);
            
            const c = COUNTRY_DB.get(id);
            if(!c) return;

            const config = SYSTEM_CONFIG[id] || { gold: "N/A", note: "Données stratégiques limitées." };

            document.getElementById('info-panel').classList.add('visible');
            document.getElementById('country-name').innerText = c.name;
            document.getElementById('stat-power').innerText = c.scores.power;
            document.getElementById('stat-threat').innerText = c.scores.threat;
            document.getElementById('stat-gold').innerText = config.gold;
            
            document.getElementById('bar-power').style.width = c.scores.power + "%";
            document.getElementById('bar-threat').style.width = c.scores.threat + "%";
            document.getElementById('bar-gold').style.width = config.gold !== "N/A" ? "70%" : "10%";

            document.getElementById('report-text').innerHTML = `
                <div class="mb-4 text-cyan-500 font-bold underline">FICHE_ID: ${c.id}</div>
                <div>${config.note}</div>
                <div class="mt-4 opacity-60">POPULATION: ${c.population.toLocaleString()}</div>
                <div class="mt-2 text-[11px] border-t border-white/10 pt-2">STATUS: NOEUD_ACTIF. Surveillance S.Y.B.I.L. continue.</div>
            `;
        }

        function hidePanel() { document.getElementById('info-panel').classList.remove('visible'); }

        window.onload = () => {
            initSystem();
            setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString('fr-FR', {hour12: false}); }, 1000);
        };
    </script>
</body>
</html>
